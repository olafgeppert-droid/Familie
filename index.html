<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wappenringe der Familie GEPPERT</title>
<link rel="icon" href="data:,">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
/* Embedded styles.css */
:root{
  --brand:#1677ff;
  --brand-dark:#0e5ed1;
  --ribbon-bg: #1976d2;
  --ribbon-fg: #fff;
  --btn-bg:#f4f6f8;
  --btn-bd:#d0d7de;
  --btn-fg:#111827;
  --danger:#dc2626;
  --ok:#10b981;
  --muted:#6b7280;
  --badge:#eef2ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#fafafa;color:#111}
.app{max-width:1220px;margin:0 auto;padding-bottom:40px}
/* Ribbon */
.ribbon{position:sticky; top:0; z-index:5; background:var(--ribbon-bg); color:var(--ribbon-fg); box-shadow:0 2px 6px rgba(0,0,0,.1);}
.ribbon .inner{padding:12px 16px}
.h1{display:flex;align-items:center;gap:10px;justify-content:center;font-size:26px;font-weight:800;letter-spacing:.5px}
.h1 img{height:28px;width:auto}
/* Second row: buttons */
.toolbar{display:flex;gap:8px;flex-wrap:wrap; align-items:center; padding:10px 16px; background:#fff; border-bottom:1px solid #e5e7eb}
.toolbar .left, .toolbar .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--btn-bd); background:var(--btn-bg); color:var(--btn-fg); border-radius:8px; cursor:pointer; font-weight:600}
.btn:hover{background:#eef2f7}
.btn[disabled]{opacity:.5;pointer-events:none}
.btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.badge{padding:3px 8px;border-radius:999px;background:var(--badge);color:#3730a3;font-weight:700;font-size:.8rem}
input[type="text"]{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;width:280px}
/* hint line */
.hint-line{padding:6px 16px;background:#fff;border-bottom:1px solid #e5e7eb}
#autoHint{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;color:#374151;max-width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
/* Table */
.table-wrap{padding:12px 16px}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{text-align:left;padding:10px 12px;background:#fff}
th{position:sticky; top:104px; z-index:1; background:#fff; box-shadow:0 1px 0 #e5e7eb}
td{border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb}
tr td:first-child, tr th:first-child{border-left:1px solid #e5e7eb;border-top-left-radius:8px;border-bottom-left-radius:8px}
tr td:last-child, tr th:last-child{border-right:1px solid #e5e7eb;border-top-right-radius:8px;border-bottom-right-radius:8px}
.required::after{content:" *";color:#ef4444}
mark{background:#fff3bf;padding:0 2px;border-radius:3px}
/* Tree */
.panel{padding:10px 16px}
#tree{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:12px;overflow:auto;min-height:260px}
.node{font-size:12px}
/* dialogs */
dialog{border:none;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:0}
dialog::backdrop{background:transparent} /* kein Abdunkeln */
.dlg-head{padding:12px 16px;background:#f4f6f8;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between}
.dlg-body{padding:16px;max-height:70vh;overflow:auto}
.dlg-actions{padding:12px 16px;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end}
.close-x{border:none;background:transparent;font-size:20px;cursor:pointer}
.form-grid{display:grid;grid-template-columns:repeat(2,minmax(180px,1fr));gap:12px}
.form-grid label{font-size:.9rem;color:#374151}
.form-grid input, .form-grid select{padding:8px;border:1px solid #d1d5db;border-radius:8px}
/* Help popup */
.help-body{max-height:70vh;overflow:auto}
#btnHelp{color:#d32f2f} /* rotes Fragezeichen */
@media (max-width:800px){
  .form-grid{grid-template-columns:1fr}
  .toolbar{justify-content:center}
  .h1{font-size:20px}
}
/* generation background palette used on SVG rects */
</style>
</head>
<body>
<div class="app">
  <!-- RIBBON -->
  <div class="ribbon">
    <div class="inner">
      <div class="h1"><img src="coat-of-arms.png" alt="" />Wappenringe der Familie GEPPERT<img src="coat-of-arms.png" alt="" /></div>
    </div>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <div class="left">
      <button class="btn" id="btnNew">‚ûï Neue Person</button>
      <button class="btn" id="btnDelete">üóëÔ∏è Person l√∂schen</button>
      <button class="btn" id="btnImport">üì• Import</button>
      <button class="btn" id="btnExport">üì§ Export</button>
      <button class="btn" id="btnPrint">üñ®Ô∏è Drucken</button>
      <button class="btn" id="btnStats">üìä Statistiken</button>
      <button class="btn" id="btnUndo">‚Ü∂ R√ºckg√§ngig</button>
      <button class="btn" id="btnRedo">‚Ü∑ Wiederholen</button>
      <button class="btn danger" id="btnReset">‚õî Reset (nur Daten)</button>
    </div>
    <div class="right">
      <input id="search" type="text" placeholder="Person suchen (Name/Code)" />
      <button class="btn" id="btnHelp">‚ùì Hilfe</button>
    </div>
  </div>

  <div class="hint-line">
    <div id="autoHint">Personen- und Ring-Code werden vom Programm vergeben. Denke daran, die Datenbank durch Export als JSON-Datei in deinem Backup-Verzeichnis zu sichern. Du kannst sie jederzeit importieren.</div>
  </div>

  <!-- TABLE -->
  <div class="table-wrap">
    <table id="peopleTable">
      <thead>
        <tr>
          <th>Gen</th><th>Code</th><th>Ring-Code</th><th>Name</th><th>Geburtsdatum</th><th>Geburtsort</th><th>Geschlecht</th><th>Eltern-Code</th><th>Partner-Code</th><th>Geerbt von</th><th>Kommentar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- TREE -->
  <div class="panel">
    <div id="tree"></div>
  </div>
</div>

<!-- DIALOGS -->
<dialog id="dlgNew">
  <form method="dialog">
    <div class="dlg-head"><strong>Neue Person</strong><button class="close-x" value="cancel" type="submit" formnovalidate aria-label="Schlie√üen">√ó</button></div>
    <div class="dlg-body">
      <div class="form-grid">
        <label> Name <input id="pName" autocomplete="off" required></label>
        <label> Geburtsdatum (TT.MM.JJJJ) <input id="pBirth" inputmode="numeric" placeholder="z.‚ÄØB. 04.12.2000"></label>
        <label> Geburtsort <input id="pPlace"></label>
        <label> Geschlecht
          <select id="pGender">
            <option value=""></option>
            <option value="m">m</option>
            <option value="w">w</option>
            <option value="d">d</option>
          </select>
        </label>
        <label> Eltern-Code <input id="pParent" placeholder="z.‚ÄØB. 1A"></label>
        <label> Partner-Code <input id="pPartner" placeholder="z.‚ÄØB. 1Ax"></label>
        <label> Geerbt von Code <input id="pInherited" placeholder="z.‚ÄØB. 1"></label>
        <label> Kommentar <input id="pNote"></label>
      </div>
    </div>
    <div class="dlg-actions">
      <button value="cancel" type="submit" formnovalidate>Abbrechen</button>
      <button id="saveNew" value="default" type="submit">Speichern</button>
    </div>
  </form>
</dialog>

<dialog id="dlgEdit">
  <form method="dialog">
    <div class="dlg-head"><strong>Person √§ndern</strong><button class="close-x" value="cancel" type="submit" formnovalidate aria-label="Schlie√üen">√ó</button></div>
    <div class="dlg-body">
      <div class="form-grid">
        <label> Name <input id="eName" required></label>
        <label> Geburtsdatum (TT.MM.JJJJ) <input id="eBirth"></label>
        <label> Geburtsort <input id="ePlace"></label>
        <label> Geschlecht
          <select id="eGender">
            <option value=""></option><option value="m">m</option><option value="w">w</option><option value="d">d</option>
          </select>
        </label>
        <label> Eltern-Code <input id="eParent"></label>
        <label> Partner-Code <input id="ePartner"></label>
        <label> Geerbt von Code <input id="eInherited"></label>
        <label> Kommentar <input id="eNote"></label>
      </div>
    </div>
    <div class="dlg-actions">
      <button value="cancel" type="submit" formnovalidate>Abbrechen</button>
      <button id="saveEdit" value="default" type="submit">Speichern</button>
    </div>
  </form>
</dialog>

<dialog id="dlgPrint">
  <div class="dlg-head"><strong>Drucken</strong><button class="close-x" value="cancel" onclick="this.closest('dialog').close()">√ó</button></div>
  <div class="dlg-body">
    <p>Bitte ausw√§hlen, was gedruckt werden soll:</p>
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" onclick="printTable()">üñ®Ô∏è Tabelle drucken</button>
      <button class="btn" onclick="printTree()">üñ®Ô∏è Baum drucken</button>
    </div>
  </div>
  <div class="dlg-actions">
    <button onclick="this.closest('dialog').close()">Schlie√üen</button>
  </div>
</dialog>

<dialog id="dlgExport">
  <div class="dlg-head"><strong>Export</strong><button class="close-x" value="cancel" onclick="this.closest('dialog').close()">√ó</button></div>
  <div class="dlg-body">
    <p>W√§hle das Format f√ºr den Export. Tipp: Diese Exporte dienen auch als <b>Backup</b>.</p>
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" onclick="exportJSON()">üìÑ JSON exportieren</button>
      <button class="btn" onclick="exportCSV()">üìÑ CSV exportieren</button>
    </div>
  </div>
  <div class="dlg-actions"><button onclick="this.closest('dialog').close()">Schlie√üen</button></div>
</dialog>

<dialog id="dlgStats">
  <div class="dlg-head"><strong>Statistiken</strong><button class="close-x" value="cancel" onclick="this.closest('dialog').close()">√ó</button></div>
  <div class="dlg-body" id="statsContent"></div>
  <div class="dlg-actions"><button onclick="this.closest('dialog').close()">Schlie√üen</button></div>
</dialog>

<dialog id="dlgHelp">
  <div class="dlg-head"><strong>‚ùì Hilfe &amp; Anleitung</strong><button class="close-x" value="cancel" onclick="this.closest('dialog').close()">√ó</button></div>
  <div class="dlg-body help-body" id="helpContent">Lade Hilfe‚Ä¶</div>
  <div class="dlg-actions"><button onclick="this.closest('dialog').close()">Schlie√üen</button></div>
</dialog>

<script>
/* Embedded app.js */
const STORAGE_KEY = "familyRingUpd56b";
const undoStack=[]; const redoStack=[];
let people = [];

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function saveState(){ undoStack.push(JSON.stringify(people)); redoStack.length=0; localStorage.setItem(STORAGE_KEY, JSON.stringify(people)); }
function loadState(){ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ people = JSON.parse(raw);} else { people = seedData(); saveState(); } }

function seedData(){
  return [
    {Gen:1, Code:"1", Name:"Olaf Geppert", Birth:"13.01.1965", BirthPlace:"Chemnitz", Gender:"m", ParentCode:"", PartnerCode:"1x", InheritedFrom:"", Note:"Stammvater"},
    {Gen:1, Code:"1x", Name:"Irina Geppert", Birth:"13.01.1970", BirthPlace:"Berlin", Gender:"w", ParentCode:"", PartnerCode:"1", InheritedFrom:"", Note:"Ehefrau von Olaf"},
    {Gen:2, Code:"1A", Name:"Mario Geppert", Birth:"28.04.1995", BirthPlace:"Berlin", Gender:"m", ParentCode:"1", PartnerCode:"1Ax", InheritedFrom:"", Note:"1. Sohn"},
    {Gen:2, Code:"1Ax", Name:"Kim", Birth:"", BirthPlace:"", Gender:"w", ParentCode:"", PartnerCode:"1A", InheritedFrom:"", Note:"Partnerin von Mario"},
    {Gen:2, Code:"1B", Name:"Nicolas Geppert", Birth:"04.12.2000", BirthPlace:"Berlin", Gender:"m", ParentCode:"1", PartnerCode:"1Bx", InheritedFrom:"", Note:"2. Sohn"},
    {Gen:2, Code:"1Bx", Name:"Annika", Birth:"", BirthPlace:"", Gender:"w", ParentCode:"", PartnerCode:"1B", InheritedFrom:"", Note:"Partnerin von Nicolas"},
    {Gen:2, Code:"1C", Name:"Julienne Geppert", Birth:"26.09.2002", BirthPlace:"Berlin", Gender:"w", ParentCode:"1", PartnerCode:"1Cx", InheritedFrom:"", Note:"Tochter"},
    {Gen:2, Code:"1Cx", Name:"Jonas", Birth:"", BirthPlace:"", Gender:"m", ParentCode:"", PartnerCode:"1C", InheritedFrom:"", Note:"Partner von Julienne"},
    {Gen:3, Code:"1C1", Name:"Michael Geppert", Birth:"12.07.2025", BirthPlace:"Hochst√§tten", Gender:"m", ParentCode:"1C", PartnerCode:"", InheritedFrom:"1", Note:""}
  ];
}

/* Compute ring codes with inheritance chain; partner ring = own code */
function computeRingCodes(){
  const byCode = Object.fromEntries(people.map(p=>[p.Code,p]));
  for(const p of people){
    if(p.InheritedFrom){
      const donor = byCode[p.InheritedFrom];
      const donorChain = donor && donor.RingCode ? donor.RingCode : p.InheritedFrom;
      p.RingCode = donorChain + "‚Üí" + p.Code;
    }else{
      p.RingCode = p.Code;
    }
  }
}

/* Rendering */
function renderTable(){
  computeRingCodes();
  const tb = $("#peopleTable tbody");
  tb.innerHTML = "";
  const q = ($("#search").value||"").trim().toLowerCase();
  const markText = (txt)=>{
    if(!q) return txt;
    const idx = txt.toLowerCase().indexOf(q);
    if(idx<0) return txt;
    return txt.substring(0,idx)+ '<mark>' + txt.substring(idx, idx+q.length) + '</mark>' + txt.substring(idx+q.length);
  };
  // Sort: Generation then code lexicographically
  people.sort((a,b)=> (a.Gen||0)-(b.Gen||0) || (a.Code > b.Code ? 1 : -1));
  for(const p of people){
    const tr = document.createElement("tr");
    const cells = [
      p.Gen||"", p.Code||"", p.RingCode||"", p.Name||"", p.Birth||"", p.BirthPlace||"", p.Gender||"", p.ParentCode||"", p.PartnerCode||"", p.InheritedFrom||"", p.Note||""
    ];
    cells.forEach((c,i)=>{
      const td=document.createElement("td");
      td.innerHTML = markText(String(c||""));
      tr.appendChild(td);
    });
    tr.addEventListener("dblclick", ()=> openEdit(p.Code));
    tb.appendChild(tr);
  }
}

function genColor(gen){
  const c=[null,"#d8f5d0","#fff4c2","#ffd1d1","#ead3ff","#cfe9ff","#ffe0b3","#e0f7fa"];
  gen=parseInt(gen||1,10); return c[gen]||"#f0f0f0";
}

function renderTree(){
  computeRingCodes();
  const el=$("#tree"); el.innerHTML="";
  const svgNS="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(svgNS,"svg");
  svg.setAttribute("width","1200"); svg.setAttribute("height","600");
  el.appendChild(svg);

  // layout: group by generation, sorted by parent grouping
  const gens={};
  for(const p of people){
    (gens[p.Gen] ||= []).push(p);
  }
  Object.values(gens).forEach(arr=>arr.sort((a,b)=> (a.ParentCode||"").localeCompare(b.ParentCode||"") || (a.Birth||"").localeCompare(b.Birth||"")));

  const nodeW=170, nodeH=42, vGap=90, hGap=30, margin=20;
  const positions=new Map();

  const genKeys=Object.keys(gens).map(n=>+n).sort((a,b)=>a-b);
  genKeys.forEach((g,gi)=>{
    const arr=gens[g]||[];
    arr.forEach((p,idx)=>{
      const x = margin + idx*(nodeW+hGap);
      const y = margin + gi*(nodeH+vGap);
      positions.set(p.Code, {x,y,p});
      const gEl=document.createElementNS(svgNS,"g"); gEl.setAttribute("class","node");
      gEl.setAttribute("transform",`translate(${x},${y})`);
      const rect=document.createElementNS(svgNS,"rect");
      rect.setAttribute("width",nodeW); rect.setAttribute("height",nodeH); rect.setAttribute("rx",8); rect.setAttribute("ry",8);
      rect.setAttribute("fill", genColor(p.Gen));
      rect.setAttribute("stroke","#cbd5e1");
      svg.appendChild(gEl);
      gEl.appendChild(rect);
      const t1=document.createElementNS(svgNS,"text");
      t1.setAttribute("x",8); t1.setAttribute("y",16); t1.textContent=`${p.Code} / ${p.Name||""}`;
      const t2=document.createElementNS(svgNS,"text");
      t2.setAttribute("x",8); t2.setAttribute("y",32); t2.textContent=`Generation: ${p.Gen||""} / ${p.Birth||""}`;
      [t1,t2].forEach(t=>{t.setAttribute("font-size","11"); t.setAttribute("fill","#111827"); gEl.appendChild(t);});
    });
  });

  // lines: parent-child vertical; partners horizontal
  for(const p of people){
    // partner line
    if(p.PartnerCode){
      const partner = people.find(x=>x.Code===p.PartnerCode);
      if(partner && positions.has(p.Code) && positions.has(partner.Code)){
        const a = positions.get(p.Code), b = positions.get(partner.Code);
        const y = a.y + nodeH/2;
        const x1 = Math.min(a.x, b.x) + nodeW; // start at right edge of left box
        const x2 = Math.max(a.x, b.x);
        const line=document.createElementNS(svgNS,"line");
        line.setAttribute("x1", x1- nodeW); line.setAttribute("y1", y);
        line.setAttribute("x2", x2); line.setAttribute("y2", y);
        line.setAttribute("stroke","#9ca3af"); line.setAttribute("stroke-width","2");
        svg.appendChild(line);
      }
    }
    // parent-child
    if(p.ParentCode && positions.has(p.ParentCode) && positions.has(p.Code)){
      const par=positions.get(p.ParentCode);
      const ch=positions.get(p.Code);
      const x = par.x + nodeW/2;
      const y1 = par.y + nodeH;
      const y2 = ch.y;
      const line=document.createElementNS(svgNS,"line");
      line.setAttribute("x1",x); line.setAttribute("y1",y1);
      line.setAttribute("x2",x); line.setAttribute("y2",y2);
      line.setAttribute("stroke","#9ca3af"); line.setAttribute("stroke-width","2");
      svg.appendChild(line);
    }
  }
}

function qs(s){ return document.querySelector(s); }

/* Printing - only selected area; via user gesture */
function printHTML(inner){
  const w = window.open("", "_blank", "noopener,noreferrer");
  if(!w){ alert("Popup-Blocker aktiv. Bitte erlauben."); return; }
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Druck</title>
  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;padding:12px}
  h1{text-align:center;font-size:20px;margin:12px 0} table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #ddd;padding:6px;font-size:12px} th{background:#f4f6f8} svg{max-width:100%;height:auto}
  </style></head><body>${inner}</body></html>`);
  w.document.close();
  w.focus(); setTimeout(()=>w.print(), 250);
}

function printTable(){
  const title = "<h1>Wappenringe der Familie GEPPERT</h1>";
  const tbl = $("#peopleTable").cloneNode(true);
  printHTML(title + tbl.outerHTML);
}
function printTree(){
  const title = "<h1>Wappenringe der Familie GEPPERT</h1>";
  const svg = $("#tree").querySelector("svg");
  const clone = svg ? svg.cloneNode(true) : document.createElement("div");
  printHTML(title + clone.outerHTML);
}

/* Export */
function exportJSON(){
  const blob = new Blob([JSON.stringify(people,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="familie.json"; a.click();
}
function exportCSV(){
  const cols=["Gen","Code","RingCode","Name","Birth","BirthPlace","Gender","ParentCode","PartnerCode","InheritedFrom","Note"];
  const lines=[cols.join(";")];
  for(const p of people){ lines.push(cols.map(c=> (p[c]??"")).join(";")); }
  const blob = new Blob([lines.join("\n")],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="familie.csv"; a.click();
}

/* Stats */
function showStats(){
  const div=$("#statsContent");
  let total=0,m=0,w=0,d=0; const gens={};
  for(const p of people){
    total++; if((p.Gender||"").toLowerCase()==="m") m++; else if((p.Gender||"").toLowerCase()==="w") w++; else if(p.Gender) d++;
    gens[p.Gen]= (gens[p.Gen]||0)+1;
  }
  let html=`<p>Gesamtanzahl Personen: <b>${total}</b></p>`;
  html+=`<p>davon m√§nnlich: <b>${m}</b> ‚Äî weiblich: <b>${w}</b> ‚Äî divers: <b>${d}</b></p>`;
  html+="<ul>";
  Object.keys(gens).sort((a,b)=>a-b).forEach(g=> html+=`<li>Generation ${g}: ${gens[g]}</li>`);
  html+="</ul>";
  div.innerHTML=html;
  $("#dlgStats").showModal();
}

/* CRUD helpers */
function parseDate(d){ // TT.MM.JJJJ -> sortable YYYY-MM-DD
  const m = /^([0-3]?\d)\.([01]?\d)\.(\d{4})$/.exec((d||"").trim());
  if(!m) return ""; return `${m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`;
}

function nextChildCode(parent){
  // Find next numeric suffix for children within same line sorted by Birth
  const kids = people.filter(p=>p.ParentCode===parent && /^[1-9]\d*$/.test(p.Code.replace(parent,""))===true);
  const usedNums = kids.map(k=> parseInt(k.Code.replace(parent,""),10)).filter(n=>!isNaN(n));
  let next = 1; while(usedNums.includes(next)) next++;
  return parent + String(next);
}

function openNew(){
  $("#pName").value=""; $("#pBirth").value=""; $("#pPlace").value="";
  $("#pGender").value=""; $("#pParent").value=""; $("#pPartner").value=""; $("#pInherited").value=""; $("#pNote").value="";
  $("#dlgNew").showModal();
}
function addNew(formEv){
  const name=$("#pName").value.trim();
  const birth=$("#pBirth").value.trim();
  const place=$("#pPlace").value.trim();
  const gender=$("#pGender").value;
  const parent=$("#pParent").value.trim();
  const partner=$("#pPartner").value.trim();
  const inherited=$("#pInherited").value.trim();
  const note=$("#pNote").value.trim();

  let gen=1, code="";
  if(parent){
    const parentP = people.find(p=>p.Code===parent);
    if(parentP){ gen = (parentP.Gen||1)+1; code = nextChildCode(parent); }
    else { gen = 1; code = parent+"1"; } // fallback
  }else{
    // Stammvater 1, Partner 1x falls PartnerCode=1
    if(partner==="1"){ code="1x"; gen=1; }
    else { code="1"; gen=1; }
  }
  const p={Gen:gen, Code:code, Name:name, Birth:birth, BirthPlace:place, Gender:gender, ParentCode:parent, PartnerCode:partner, InheritedFrom:inherited, Note:note};
  people.push(p);
  saveState();
  renderTable(); renderTree();
}

let editCode=null;
function openEdit(code){
  const p=people.find(x=>x.Code===code); if(!p) return;
  editCode=code;
  $("#eName").value=p.Name||""; $("#eBirth").value=p.Birth||""; $("#ePlace").value=p.BirthPlace||"";
  $("#eGender").value=p.Gender||""; $("#eParent").value=p.ParentCode||""; $("#ePartner").value=p.PartnerCode||""; $("#eInherited").value=p.InheritedFrom||""; $("#eNote").value=p.Note||"";
  $("#dlgEdit").showModal();
}
function saveEditFn(){
  const p=people.find(x=>x.Code===editCode); if(!p) return;
  p.Name=$("#eName").value.trim();
  p.Birth=$("#eBirth").value.trim();
  p.BirthPlace=$("#ePlace").value.trim();
  p.Gender=$("#eGender").value;
  p.ParentCode=$("#eParent").value.trim();
  p.PartnerCode=$("#ePartner").value.trim();
  p.InheritedFrom=$("#eInherited").value.trim();
  p.Note=$("#eNote").value.trim();
  saveState(); renderTable(); renderTree();
}

function deletePerson(){
  const id = prompt("Bitte Namen oder Personen-Code der zu l√∂schenden Person eingeben:");
  if(!id) return;
  const idx = people.findIndex(p=> p.Code===id || (p.Name||"").toLowerCase()===id.toLowerCase());
  if(idx<0){ alert("Person nicht gefunden."); return; }
  const code = people[idx].Code;
  people.splice(idx,1);
  // remove references
  people.forEach(p=>{
    if(p.ParentCode===code) p.ParentCode="";
    if(p.PartnerCode===code) p.PartnerCode="";
    if(p.InheritedFrom===code) p.InheritedFrom="";
  });
  saveState(); renderTable(); renderTree();
}

/* Search */
$("#search").addEventListener("input", renderTable);

/* Buttons */
$("#btnNew").addEventListener("click", openNew);
$("#saveNew").addEventListener("click", (e)=>{ e.preventDefault(); addNew(); $("#dlgNew").close(); });
// Abbrechen funktioniert immer (auch ohne Namen), durch formnovalidate & value=cancel am X-Button/Abbrechen
$("#saveEdit").addEventListener("click", (e)=>{ e.preventDefault(); saveEditFn(); $("#dlgEdit").close(); });

$("#btnDelete").addEventListener("click", deletePerson);
$("#btnImport").addEventListener("click", ()=>{ const inp=document.createElement("input"); inp.type="file"; inp.accept=".json,application/json"; inp.onchange=()=>{
  const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ people=JSON.parse(r.result); saveState(); renderTable(); renderTree(); }catch(e){ alert("Ung√ºltige Datei"); } }; r.readAsText(f);
}; inp.click(); });
$("#btnExport").addEventListener("click", ()=> $("#dlgExport").showModal() );
$("#btnPrint").addEventListener("click", ()=> $("#dlgPrint").showModal() );
$("#btnStats").addEventListener("click", showStats);
$("#btnHelp").addEventListener("click", ()=>{
  fetch("help.html").then(r=>r.text()).then(html=>{ $("#helpContent").innerHTML=html; $("#dlgHelp").showModal(); });
});
$("#btnReset").addEventListener("click", ()=>{
  if(confirm("Sollen wirklich alle Personen gel√∂scht werden?")){ people=[]; saveState(); renderTable(); renderTree(); }
});
$("#btnUndo").addEventListener("click", ()=>{
  if(!undoStack.length) return;
  redoStack.push(JSON.stringify(people));
  people = JSON.parse(undoStack.pop());
  localStorage.setItem(STORAGE_KEY, JSON.stringify(people));
  renderTable(); renderTree();
});
$("#btnRedo").addEventListener("click", ()=>{
  if(!redoStack.length) return;
  undoStack.push(JSON.stringify(people));
  people = JSON.parse(redoStack.pop());
  localStorage.setItem(STORAGE_KEY, JSON.stringify(people));
  renderTable(); renderTree();
});

/* init */
loadState(); renderTable(); renderTree();
</script>
</body>
</html>
